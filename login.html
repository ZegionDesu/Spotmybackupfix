<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="config.js"></script>
    <title>Login</title>
</head>
<body>

<script>
// SAFE PKCE GENERATOR
function generateRandomString(length) {
    let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

async function sha256(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    return await crypto.subtle.digest('SHA-256', data);
}

function base64encode(buffer) {
    let binary = '';
    let bytes = new Uint8Array(buffer);
    bytes.forEach(b => binary += String.fromCharCode(b));
    return btoa(binary)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
}

(async () => {
    const verifier = generateRandomString(64);
    localStorage.setItem("pkce_verifier", verifier);

    const hash = await sha256(verifier);
    const challenge = base64encode(hash);

    const params = new URLSearchParams({
        client_id: config.client_id,
        response_type: "code",
        redirect_uri: config.redirect_uri,
        code_challenge_method: "S256",
        code_challenge: challenge,
        scope: "playlist-read-private playlist-modify-private playlist-modify-public user-library-read user-library-modify"
    });

    window.location.href = "https://accounts.spotify.com/authorize?" + params.toString();
})();
</script>

</body>
</html>
