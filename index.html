<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SpotMyBackup (PKCE)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <script src="config.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; background:#f7f7f7; color:#222; padding:20px; }
    .container { max-width:960px; margin:0 auto; background:#fff; padding:18px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    h1 { margin-top:0; }
    .button { background:#1DB954; color:white; padding:10px 18px; border-radius:8px; border:0; cursor:pointer; font-weight:600; }
    .button.secondary { background:#2e86de; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .muted { color:#666; font-size:14px; }
    pre { background:#f1f1f1; padding:10px; border-radius:6px; overflow:auto; }
    .progress { height:14px; background:#eee; border-radius:8px; overflow:hidden; margin-top:8px; }
    .progress > i { display:block; height:100%; width:0%; background:#1DB954; transition:width .25s linear; }
    .hidden { display:none; }
    input[type=file] { margin-left:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SpotMyBackup</h1>
    <p class="muted">Export your playlists/tracks to a file, and import it back later.</p>

    <div id="statusArea" class="muted">Checking login status…</div>

    <div id="controls" class="hidden">
      <div class="row" style="margin-top:12px;">
        <button id="btnLogout" class="button secondary">Logout</button>
        <button id="btnRefresh" class="button">Refresh playlists</button>
        <button id="btnExport" class="button">Export</button>

        <label class="muted" style="margin-left:8px">Import JSON:
          <input id="fileImport" type="file" accept=".json">
        </label>
      </div>

      <div id="stats" style="margin-top:14px;">
        <div>Account: <b id="userName">—</b></div>
        <div id="counts" class="muted" style="margin-top:6px"></div>
      </div>

      <div id="progressArea" style="margin-top:12px;display:none;">
        <div id="progressText" class="muted"></div>
        <div class="progress"><i id="progressBar"></i></div>
      </div>

      <div id="log" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/* --------- Helpers --------- */
function $(sel){return document.querySelector(sel);}
function $all(sel){return Array.from(document.querySelectorAll(sel));}
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
function setLog(msg, clear=false){ const el=$('#log'); if(clear) el.innerHTML=''; el.innerHTML += '<div>'+msg+'</div>'; }

/* --------- Config & Token --------- */
const cfg = window.config || { client_id:'', redirect_uri:'', origin: location.origin, slowdown_import:200, slowdown_export:200 };
let token = localStorage.getItem('spotify_token') || null;

/* --------- Startup --------- */
window.addEventListener('load', startup);

async function startup(){
  // if no token -> go to login
  if(!token){
    // If page has code from PKCE callback redirect (some flows redirect to index.html?),
    // but our callback stores token in localStorage. So if still no token, redirect to login.
    // Keep status
    $('#statusArea').textContent = 'Not logged in — redirecting to login…';
    // small timeout to show status
    await sleep(200);
    window.location.href = 'login.html';
    return;
  }

  // token present - initialize UI
  $('#statusArea').textContent = 'Logged in, fetching account...';
  $('#controls').classList.remove('hidden');

  bindControls();
  await refreshUserAndPlaylists();
}

/* --------- UI bindings --------- */
function bindControls(){
  $('#btnLogout').onclick = () => {
    localStorage.removeItem('spotify_token');
    localStorage.removeItem('pkce_verifier');
    token = null;
    window.location.href = 'login.html';
  };
  $('#btnRefresh').onclick = async () => {
    await refreshUserAndPlaylists();
  };
  $('#btnExport').onclick = exportCollections;
  $('#fileImport').addEventListener('change', handleFileSelect);
}

/* --------- API helpers --------- */
async function apiFetch(url, method='GET', body=null){
  const headers = { 'Authorization': 'Bearer ' + token };
  if(body && !(body instanceof FormData)) {
    headers['Content-Type'] = 'application/json';
  }
  const res = await fetch(url, { method, headers, body: body && (body instanceof FormData ? body : JSON.stringify(body)) });
  if(res.status === 401){
    // token invalid/expired — force login
    setLog('Token expired or invalid — please login again.', true);
    localStorage.removeItem('spotify_token');
    window.location.href = 'login.html';
    throw new Error('Unauthorized');
  }
  return res.json();
}

/* --------- Fetch user + playlists --------- */
let userId = null;
let collections = { playlists: {}, saved: [], starred: [] };

async function refreshUserAndPlaylists(){
  try{
    $('#statusArea').textContent = 'Loading account...';
    const me = await apiFetch('https://api.spotify.com/v1/me');
    userId = me.id;
    $('#userName').textContent = me.display_name || me.id;
    setLog('Loaded account: ' + (me.display_name || me.id), true);

    // load playlists (paginated)
    await loadAllPlaylists();
    refreshCounts();
  }catch(e){
    console.error(e);
    setLog('Error loading account: ' + e.message, true);
  }
}

async function loadAllPlaylists(){
  $('#statusArea').textContent = 'Loading playlists...';
  collections.playlists = {};
  let url = `https://api.spotify.com/v1/me/playlists?limit=50`;
  while(url){
    const data = await apiFetch(url);
    data.items.forEach(pl => {
      collections.playlists[pl.name] = { id: pl.id, href: pl.tracks.href, tracks: [] };
    });
    url = data.next;
  }

  // for each playlist we'll load tracks count lazily or on export
  setLog('Found ' + Object.keys(collections.playlists).length + ' playlists.');
}

/* --------- Counts & progress UI --------- */
function refreshCounts(){
  const playlistCount = Object.keys(collections.playlists).length;
  $('#counts').textContent = `${playlistCount} playlists.`;
}

/* --------- Export logic --------- */
async function exportCollections(){
  $('#progressArea').style.display = 'block';
  $('#progressText').textContent = 'Exporting playlists and saved tracks...';
  $('#progressBar').style.width = '0%';
  setLog('Starting export...', true);

  const exportObj = { playlists: {}, saved: [] };

  // Fetch playlist tracks one by one (respect slowdown_export)
  const names = Object.keys(collections.playlists);
  let completed = 0;
  for(const name of names){
    const pl = collections.playlists[name];
    // fetch tracks pages
    let next = `https://api.spotify.com/v1/playlists/${pl.id}/tracks?limit=100`;
    const trackUris = [];
    while(next){
      const data = await apiFetch(next);
      data.items.forEach(it => {
        if(it.track && it.track.uri) trackUris.push({ uri: it.track.uri, name: it.track.name });
      });
      next = data.next;
    }
    exportObj.playlists[name] = { tracks: trackUris };
    completed++;
    $('#progressBar').style.width = Math.round((completed / names.length) * 100) + '%';
    await sleep(cfg.slowdown_export || 200);
  }

  // Fetch saved tracks (liked)
  let nextSaved = 'https://api.spotify.com/v1/me/tracks?limit=50';
  while(nextSaved){
    const data = await apiFetch(nextSaved);
    data.items.forEach(it => {
      if(it.track && it.track.uri) exportObj.saved.push({ uri: it.track.uri, name: it.track.name });
    });
    nextSaved = data.next;
  }

  // download JSON
  const filename = 'spotmybackup_' + (new Date()).toISOString().replace(/[:.]/g,'-') + '.json';
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);

  $('#progressArea').style.display = 'none';
  setLog('Export finished. File downloaded: ' + filename, true);
}

/* --------- Import logic (basic) --------- */
let importColl = null;

function handleFileSelect(e){
  const f = e.target.files[0];
  if(!f){ return; }
  const reader = new FileReader();
  reader.onload = async function(ev){
    try{
      importColl = JSON.parse(ev.target.result);
      setLog('Import file loaded. Preparing to import...');
      await processImport();
    } catch(err){
      setLog('Invalid JSON file: ' + err.message, true);
    }
  };
  reader.readAsText(f);
}

async function processImport(){
  if(!importColl) return setLog('No import data found', true);
  // For simplicity: create playlists from import that do not exist, then add tracks
  const names = Object.keys(importColl.playlists || {});
  let count = 0;
  $('#progressArea').style.display = 'block';
  $('#progressText').textContent = 'Importing playlists...';
  $('#progressBar').style.width = '0%';

  for(const name of names){
    count++;
    // if playlist exists, skip creation; else create
    if(!(name in collections.playlists)){
      // create playlist
      const body = { name: name, public: false };
      const res = await fetch(`https://api.spotify.com/v1/users/${encodeURIComponent(userId)}/playlists`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      }).then(r=>r.json());
      if(res && res.id){
        collections.playlists[name] = { id: res.id, href: res.tracks.href, tracks: [] };
        setLog('Created playlist: ' + name);
      } else {
        setLog('Failed creating playlist: ' + name);
      }
    } else {
      setLog('Playlist exists, will add tracks: ' + name);
    }

    // add tracks in batches of 100
    const tracks = (importColl.playlists[name] && importColl.playlists[name].tracks) || [];
    const uris = tracks.map(t => t.uri).filter(Boolean);
    while(uris.length){
      const batch = uris.splice(0,100);
      const url = `https://api.spotify.com/v1/playlists/${collections.playlists[name].id}/tracks?uris=${encodeURIComponent(batch.join(','))}`;
      await fetch(url, { method: 'POST', headers: { 'Authorization':'Bearer '+token }});
      await sleep(cfg.slowdown_import || 200);
    }

    $('#progressBar').style.width = Math.round((count / names.length) * 100) + '%';
  }

  $('#progressArea').style.display = 'none';
  setLog('Import finished.', true);
  // refresh playlists
  await loadAllPlaylists();
  refreshCounts();
}

/* --------- End --------- */
</script>
</body>
</html>
